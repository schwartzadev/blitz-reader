<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Blitz Reader</title>
</head>
<body>
	<textarea id="words-input" rows="20"></textarea>
	<br>
	<button onclick="start()">Go!</button>
	<div class="wordviewer-container">
		<h1 id="wordviewer"></h1>
	</div>
	<!-- todo make speed slider, save to cookies -->
	<!-- todo add pause button (also via space) -->
</body>
<style type="text/css">
	#words-input {
		width: 90%;
		margin: 0 5%;
	}

	.wordviewer-container {
		margin: 3em;
	}

	.wordviewer-container h1 {
		font-size: 12vw;
		text-align: center;
	}

</style>
<script type="text/javascript">


	function start() {
		data = prepareWords(); // todo update this in production
		readWords(data, 500);
	}

	function prepareWords() {
		var content = document.getElementById("words-input").value;
		var words = content.split(/([\s|\n|\u2014|\u2013])/);
		clean_words_array(words);
		data = make_word_lengths(words);
		return data
	}

	async function readWords(data, wpm) {
		var viewer = document.getElementById("wordviewer");
		for (var item of data) {
			viewer.innerHTML = item.word;
			await sleep(wordsPerMinuteToMsPerWord(wpm, item));
		};
	}

	function wordsPerMinuteToMsPerWord(wpm, item) {
		// this seems confusing but it takes a WPM value and returns
		// the duration of each word to achieve the given WPM
		// 1 m = 60 s = 60,000 ms
		var base = 60000 / wpm;
		base += item.puncuation_wait * 80;  // add an additional delay for punctuation characters

		return base
	}

	async function runWord(viewer, word, timeout) {
		await sleep(timeout);
	}

	function clean_words_array(words) {
		words.forEach(function(word, index, object) {
			if (word == ' ') {
				words.splice(index, 1);
			}
			if (word == '\u2014' || word == '\u2013') {  // add dash to previous word
				words.splice(index - 1, 2, object[index - 1] + word);  // remove the dash and the word, replace the two with the combined string
			}
		});
	}

	function make_word_lengths(words) {
		var results = [];
		words.forEach(function(word, index, object) {
			var special = 0;
			if ( word.includes('.') || word.includes('?') || word.includes('!') ) {
				special += 3
			} else if (word.includes(';')) {
				special += 2
			} else if ( word.includes(',') || word.includes('\u2014') || word.includes('\u2013') ) {
				special += 2
			}

			var info = {
				'word': word,
				'length': word.length,
				'puncuation_wait': special
			};
			results.push(info);
		});
		return results;
	}

	function sleep(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}

	function splitValue(value, index) {
		return [value.substring(0, index+1), value.substring(index+1)];
	}

</script>
</html>
